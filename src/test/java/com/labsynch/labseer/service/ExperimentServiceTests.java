package com.labsynch.labseer.service;

import java.io.BufferedReader;
import java.io.StringReader;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;

import com.labsynch.labseer.domain.AnalysisGroup;
import com.labsynch.labseer.domain.AnalysisGroupLabel;
import com.labsynch.labseer.domain.AnalysisGroupState;
import com.labsynch.labseer.domain.AnalysisGroupValue;
import com.labsynch.labseer.domain.Experiment;
import com.labsynch.labseer.domain.ExperimentLabel;
import com.labsynch.labseer.domain.ExperimentState;
import com.labsynch.labseer.domain.ExperimentValue;
import com.labsynch.labseer.domain.ItxSubjectContainer;
import com.labsynch.labseer.domain.ItxSubjectContainerState;
import com.labsynch.labseer.domain.ItxSubjectContainerValue;
import com.labsynch.labseer.domain.LsTransaction;
import com.labsynch.labseer.domain.Protocol;
import com.labsynch.labseer.domain.Subject;
import com.labsynch.labseer.domain.SubjectLabel;
import com.labsynch.labseer.domain.SubjectState;
import com.labsynch.labseer.domain.SubjectValue;
import com.labsynch.labseer.domain.TreatmentGroup;
import com.labsynch.labseer.domain.TreatmentGroupLabel;
import com.labsynch.labseer.domain.TreatmentGroupState;
import com.labsynch.labseer.domain.TreatmentGroupValue;
import com.labsynch.labseer.dto.CodeTableDTO;
import com.labsynch.labseer.dto.DateValueComparisonRequest;
import com.labsynch.labseer.exceptions.NotFoundException;
import com.labsynch.labseer.exceptions.TooManyResultsException;
import com.labsynch.labseer.exceptions.UniqueNameException;

import org.apache.commons.io.IOUtils;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Configurable;
import org.springframework.test.annotation.Rollback;
import org.springframework.test.context.ContextConfiguration;
import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;
import org.springframework.transaction.annotation.Transactional;

import junit.framework.Assert;

@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration(locations = {
		"classpath:/META-INF/spring/applicationContext.xml",
		"classpath:/META-INF/spring/applicationContext-security.xml" })
@Configurable
public class ExperimentServiceTests {

	private static final Logger logger = LoggerFactory
			.getLogger(ExperimentServiceTests.class);

	@Autowired
	private ExperimentService experimentService;

	@Autowired
	private ExperimentValueService experimentValueService;

	// @Test
	@Transactional
	public void CreateProtocolTest_1() {
		Protocol protocol = new Protocol();
		protocol.setLsType("test protocol type");
		protocol.setLsKind("test protocol kind");
		protocol.setCodeName("test experiment_" + Protocol.countProtocols() + 1);
		protocol.setShortDescription("just a test");
		protocol.setRecordedBy("testUser");
		protocol.setRecordedDate(new Date());
		LsTransaction tx = new LsTransaction();
		tx.setRecordedDate(new Date());
		tx.persist();
		protocol.setLsTransaction(tx.getId());
		protocol.persist();
		logger.info(protocol.toJson());
		long id = protocol.getId();
		Assert.assertNotNull(
				"Find method for 'Protocol' illegally returned null for id '"
						+ id + "'",
				id);
	}

	// @Test
	// @Transactional
	public void CreateExperimentTest_2() {
		String userName = "testUser";
		Date recordedDate = new Date();

		LsTransaction lsTransaction = new LsTransaction();
		lsTransaction.setRecordedDate(recordedDate);
		lsTransaction.persist();

		Protocol protocol = new Protocol();
		protocol.setLsTransaction(lsTransaction.getId());
		protocol.setRecordedBy(userName);
		protocol.setRecordedDate(recordedDate);
		protocol.setCodeName("test protocol code name 105");
		protocol.setShortDescription("just a test");
		protocol.setLsType("default");
		protocol.setLsKind("default");
		protocol.persist();

		Experiment experiment = new Experiment();
		experiment.setProtocol(protocol);
		experiment.setLsTransaction(lsTransaction.getId());
		experiment.setRecordedBy(userName);
		experiment.setRecordedDate(recordedDate);
		experiment.setCodeName("test experiment code name 105");
		experiment.setShortDescription("some short description");
		experiment.setLsKind("default");
		experiment.setLsType("default");
		experiment.persist();

		logger.info("experiment saved: " + experiment.toPrettyJson());

		ExperimentLabel experimentLabel = new ExperimentLabel();
		experimentLabel.setExperiment(experiment);
		experimentLabel.setLabelText("Expt Test 105");
		experimentLabel.setRecordedBy(userName);
		experimentLabel.setRecordedDate(recordedDate);
		experimentLabel.setLsTransaction(lsTransaction.getId());
		experimentLabel.setLsType("name");
		experimentLabel.setLsKind("experiment name");
		experimentLabel.persist();

		AnalysisGroup ag = new AnalysisGroup();
		Set<Experiment> experiments = new HashSet<Experiment>();
		experiments.add(experiment);
		ag.setExperiments(experiments);
		ag.setRecordedBy(userName);
		ag.setRecordedDate(recordedDate);
		ag.setLsTransaction(lsTransaction.getId());
		ag.setLsType("default");
		ag.setLsKind("default");
		ag.persist();

		AnalysisGroupState ags = new AnalysisGroupState();
		ags.setAnalysisGroup(ag);
		ags.setRecordedBy(userName);
		ags.setRecordedDate(recordedDate);
		ags.setLsTransaction(lsTransaction.getId());
		ags.setLsType("data");
		ags.setLsKind("results");
		ags.persist();

		AnalysisGroupValue agv = new AnalysisGroupValue();
		agv.setLsState(ags);
		agv.setRecordedBy(userName);
		agv.setRecordedDate(recordedDate);
		agv.setLsTransaction(lsTransaction.getId());
		agv.setLsType("stringValue");
		agv.setLsKind("status");
		agv.persist();

		TreatmentGroup tg = new TreatmentGroup();
		Set<AnalysisGroup> analysisGroups = new HashSet<AnalysisGroup>();
		analysisGroups.add(ag);
		tg.setAnalysisGroups(analysisGroups);
		tg.setRecordedBy(userName);
		tg.setRecordedDate(recordedDate);
		tg.setLsTransaction(lsTransaction.getId());
		tg.setLsType("default");
		tg.setLsKind("default");
		tg.persist();

		TreatmentGroupState tgs = new TreatmentGroupState();
		tgs.setTreatmentGroup(tg);
		tgs.setRecordedBy(userName);
		tgs.setRecordedDate(recordedDate);
		tgs.setLsTransaction(lsTransaction.getId());
		tgs.setLsType("data");
		tgs.setLsKind("results");
		tgs.persist();

		TreatmentGroupValue tgv = new TreatmentGroupValue();
		tgv.setLsState(tgs);
		tgv.setRecordedBy("daffy duck");
		tgv.setRecordedDate(recordedDate);
		tgv.setLsTransaction(lsTransaction.getId());
		tgv.setLsType("stringValue");
		tgv.setLsKind("status");
		tgv.persist();

		// TreatmentGroupValue findTgv =
		// TreatmentGroupValue.findTreatmentGroupValue(tgv.getId());
		// logger.info("found the tgv: " + findTgv.getRecordedBy());

		// logger.info(experiment.toJson());
		// logger.info(Experiment.findExperiment(experiment.getId()).toJson());

	}

	// @Test
	public void UpdateExeprimentName_2() {
		String json = "{    \"analysisGroups\": null,    \"codeName\": \"test experiment code name 105\",    \"id\": 3101,    \"ignored\": false,    \"lsKind\": \"default\",    \"lsLabels\": null,    \"lsStates\": null,    \"lsTransaction\": 311,    \"lsType\": \"default\",    \"lsTypeAndKind\": \"default_default\",    \"modifiedBy\": null,    \"modifiedDate\": null,    \"protocol\": {        \"codeName\": \"test protocol code name 105\",        \"id\": 3100,        \"ignored\": false,        \"lsKind\": \"default\",        \"lsTransaction\": 311,        \"lsType\": \"default\",        \"lsTypeAndKind\": \"default_default\",        \"modifiedBy\": null,        \"modifiedDate\": null,        \"recordedBy\": \"testUser\",        \"recordedDate\": 1379479721768,        \"shortDescription\": \"just a test\",        \"version\": 0    },    \"recordedBy\": \"testUser\",    \"recordedDate\": 1379479721768,    \"shortDescription\": \"some short description\",    \"version\": 0}";
		try {
			experimentService.updateExperiment(Experiment
					.fromJsonToExperiment(json));
		} catch (Exception e) {
			Assert.assertNull(e);
		}
	}

	// @Test
	// @Transactional
	public void CreateProtocolFromSimpleJson_3()
			throws UniqueNameException, NotFoundException {
		String json = "{\"protocol\":{\"codeName\":\"PROT-00000007\",\"id\":14,\"ignored\":false,\"lsKind\":\"default\",\"lsLabels\":[{\"id\":9,\"ignored\":false,\"imageFile\":null,\"labelText\":\"test\",\"lsKind\":\"protocol name\",\"lsTransaction\":10,\"lsType\":\"name\",\"lsTypeAndKind\":\"name_protocol name\",\"modifiedDate\":null,\"physicallyLabled\":false,\"preferred\":true,\"recordedBy\":\"smeyer\",\"recordedDate\":1371828671000,\"version\":0}],\"lsStates\":[],\"lsTransaction\":10,\"lsType\":\"default\",\"lsTypeAndKind\":\"default_default\",\"modifiedBy\":null,\"modifiedDate\":null,\"recordedBy\":\"smeyer\",\"recordedDate\":1371828794000,\"shortDescription\":\"protocol created by generic data parser\",\"version\":1},\"codeName\":\"EXPT-00000004\",\"lsType\":\"default\",\"lsKind\":\"default\",\"shortDescription\":\"experiment created by generic data parser\",\"recordedBy\":\"smeyer\",\"lsTransaction\":10,\"lsLabels\":[],\"lsStates\":[]}";
		Experiment experiment = experimentService.saveLsExperiment(Experiment
				.fromJsonToExperiment(json));
		logger.info(experiment.toJson());

	}

	// @Test
	// @Transactional
	public void CreateProtocolFromNestedJson()
			throws UniqueNameException, NotFoundException {
		// String json =
		// "{ \"name\": \"\",\"shortDescription\": \"\",\"lsTransaction\":
		// null,\"protocolStates\": [ { \"protocolValues\": [ { \"valueType\":
		// \"stringValue\",\"valueKind\": \"reader instrument\",\"stringValue\":
		// \"Molecular Dynamics FLIPR\",\"fileValue\": null,\"urlValue\":
		// null,\"dateValue\": null,\"clobValue\": null,\"blobValue\":
		// null,\"valueOperator\": null,\"numericValue\": null,\"sigFigs\":
		// null,\"uncertainty\": null,\"valueUnit\": null,\"concValue\":
		// null,\"concUnit\": \"\",\"comments\": null,\"ignored\":
		// false,\"lsTransaction\": null,\"thingIdValue\": null,\"sampleId\":
		// null,\"sampleName\": \"\",\"publicData\": false,\"recordedDate\":
		// 1353216427000 },{ \"valueType\": \"numericValue\",\"valueKind\": \"curve
		// min\",\"stringValue\": null,\"fileValue\": null,\"urlValue\":
		// null,\"dateValue\": null,\"clobValue\": null,\"blobValue\":
		// null,\"valueOperator\": null,\"numericValue\": 0,\"sigFigs\":
		// 2,\"uncertainty\": null,\"valueUnit\": null,\"concValue\": null,\"concUnit\":
		// \"\",\"comments\": null,\"ignored\": false,\"lsTransaction\":
		// null,\"thingIdValue\": null,\"sampleId\": null,\"sampleName\":
		// \"\",\"publicData\": false,\"recordedDate\": 1353216427000 },{ \"valueType\":
		// \"numericValue\",\"valueKind\": \"curve max\",\"stringValue\":
		// null,\"fileValue\": null,\"urlValue\": null,\"dateValue\":
		// null,\"clobValue\": null,\"blobValue\": null,\"valueOperator\":
		// null,\"numericValue\": 100,\"sigFigs\": 2,\"uncertainty\":
		// null,\"valueUnit\": null,\"concValue\": null,\"concUnit\": \"\",\"comments\":
		// null,\"ignored\": false,\"lsTransaction\": null,\"thingIdValue\":
		// null,\"sampleId\": null,\"sampleName\": \"\",\"publicData\":
		// false,\"recordedDate\": 1353216427000 } ],\"recordedBy\":
		// \"userName\",\"stateType\": \"metadata\",\"stateKind\": \"protocol
		// parameters\",\"comments\": \"\",\"lsTransaction\": null,\"ignored\":
		// false,\"recordedDate\": 1353216427000 } ] }";
		String json = "{\"kind\":\"primary analysis\",\"recordedBy\":\"jmcneil\",\"recordedDate\":1363503600000,\"shortDescription\":\"primary 7:34\",\"description\":\"\", \"experimentLabels\":[{\"labelType\":\"name\",\"labelKind\":\"experiment name\",\"labelText\":\"john 7:34\",\"ignored\":false,\"preferred\":true,\"recordedDate\":1363503600000,\"recordedBy\":\"jmcneil\",\"physicallyLabled\":false,\"imageFile\":null}],\"experimentStates\":[], \"protocol\":{\"kind\":\"primary analysis\",\"recordedBy\":\"username\",\"shortDescription\":\"primary analysis\",\"description\":\"\", \"codeName\":\"PROT-00000003\",\"id\":96,\"ignored\":false,\"lsTransaction\":{\"comments\":\"primary analysis protocol transactions\",\"id\":87,\"recordedDate\":1363388477000,\"version\":0},\"modifiedBy\":null,\"modifiedDate\":null,\"recordedDate\":1363388477000,\"version\":1}}";
		// TODO: fix json
		Experiment experiment = experimentService.saveLsExperiment(Experiment
				.fromJsonToExperiment(json));
		logger.info("-------DONE SAVING THE EXPERIMENT----------");
		logger.info(Experiment.findExperiment(experiment.getId()).toJson());

		// Protocol protocol = Protocol.fromJsonToProtocol(json);
		// logger.info("initial json values: " + protocol.toJson());
		//
		// protocol.persist();
		// logger.info(protocol.toJson());

	}

	// @Test
	@Transactional
	// TODO: fix this test to either test SEL delete route (real delete) or Browser
	// delete route (soft delete via status)
	public void RemoveExperimentTest() {
		Long id = 136951L;
		Experiment experiment = Experiment.findExperiment(id);
		Experiment.deleteExperiment(experiment);
		Assert.assertNull(Experiment.findExperiment(id));
	}

	// @Test
	@Transactional
	public void DeleteExperimentTest1() {
		Experiment experiment = Experiment.findExperiment(1684L);
		// logger.info(experiment.toJson());
		// experiment.remove();
		// logger.info(experiment.getCodeName());
		if (experiment != null) {
			// Experiment.deleteExperiment(experiment);
			// List<ItxSubjectContainer> results =
			// ItxSubjectContainer.findItxSubjectContainerByExperimentID(experiment.getId());
			// logger.debug("number of results: " + results.size());
			int dels = ItxSubjectContainer.deleteByExperimentID(experiment
					.getId());
			logger.debug("deleted number " + dels);
		} else {
			logger.error("Experiment is null");
		}
		// logger.info(experiment.toJson());
	}

	// @Test
	@Transactional
	public void createExperiment_test2() throws UniqueNameException, NotFoundException {
		String json = "";
		Experiment experiment = experimentService.saveLsExperiment(Experiment
				.fromJsonToExperiment(json));
		logger.info(experiment.toJson());

	}

	// @Test
	// @Transactional
	public void createExperiment_test3() {
		Collection<ExperimentValue> savedExperimentValues = new ArrayList<ExperimentValue>();
		String json = "[{\"lsState\":{\"comments\":\"\",\"experiment\":{\"codeName\":\"EXPT-00012336\",\"id\":233771,\"ignored\":false,\"lsKind\":\"default\",\"lsTransaction\":13734,\"lsType\":\"default\",\"lsTypeAndKind\":\"default_default\",\"protocol\":{\"codeName\":\"PROT-00000004\",\"id\":4,\"ignored\":false,\"lsKind\":\"default\",\"lsTransaction\":4,\"lsType\":\"default\",\"lsTypeAndKind\":\"default_default\",\"recordedBy\":\"smeyer\",\"recordedDate\":1374024874000,\"shortDescription\":\"dmpk protocol\",\"version\":1},\"recordedBy\":\"smeyer\",\"recordedDate\":1384536207000,\"shortDescription\":\"experiment created by generic data parser\",\"version\":1},\"id\":256582,\"ignored\":false,\"lsKind\":\"raw results locations\",\"lsTransaction\":13734,\"lsType\":\"metadata\",\"lsTypeAndKind\":\"metadata_raw results locations\",\"recordedBy\":\"smeyer\",\"recordedDate\":1384536208000,\"version\":0},\"lsType\":\"fileValue\",\"lsKind\":\"source file\",\"stringValue\":null,\"fileValue\":\"FILE209321\",\"urlValue\":null,\"dateValue\":null,\"clobValue\":null,\"blobValue\":null,\"operatorKind\":null,\"operatorType\":null,\"numericValue\":null,\"sigFigs\":null,\"uncertainty\":null,\"uncertaintyType\":null,\"numberOfReplicates\":null,\"unitKind\":null,\"comments\":null,\"ignored\":false,\"publicData\":true,\"codeValue\":null,\"recordedBy\":\"smeyer\",\"recordedDate\":1384536208000,\"lsTransaction\":13734}]";
		int batchSize = 50;
		int i = 0;
		StringReader sr = new StringReader(json);
		BufferedReader br = new BufferedReader(sr);
		for (ExperimentValue experimentValue : ExperimentValue
				.fromJsonArrayToExperimentValues(br)) {
			experimentValue.persist();
			savedExperimentValues.add(experimentValue);

			if (i % batchSize == 0) {
				experimentValue.flush();
				experimentValue.clear();
			}
			i++;
		}
		IOUtils.closeQuietly(sr);
		IOUtils.closeQuietly(br);

		logger.debug(ExperimentValue.toJsonArray(savedExperimentValues));

	}

	// @Test
	@Transactional
	public void updateExperiment_test3() {

		List<Experiment> experiments = Experiment.findExperimentEntries(0, 2);
		Experiment testExperiment = experiments.get(0);

		Set<ExperimentState> lsStates = testExperiment.getLsStates();
		for (ExperimentState lsState : lsStates) {
			for (ExperimentValue ev : lsState.getLsValues()) {
				ev.setIgnored(false);
				ev.setComments("testing updates");
			}
		}

		logger.debug("test experiment: " + testExperiment.toPrettyJson());

	}

	// @Test
	@Transactional
	public void deleteExperimentAnalysisGroups() {
		long id = 140116L;

		// Experiment experiment = Experiment.findExperiment(id);
		//
		// // logger.debug("deleting analysis groups within an experiment: " +
		// id);
		// //
		// // logger.debug("first get a fresh count of all objects");
		// //
		// List<AnalysisGroup> analysisGroups =
		// AnalysisGroup.findAnalysisGroupsByExperiment(Experiment.findExperiment(id)).getResultList();
		// int numberOfAnalysisGroups = analysisGroups.size();
		// logger.debug("total number of numberOfAnalysisGroups: " +
		// numberOfAnalysisGroups);
		//
		// HashSet<Long> lsTranasactionIds = new HashSet<Long>();
		// for (AnalysisGroup analysisGroup : analysisGroups){
		// lsTranasactionIds.add(analysisGroup.getLsTransaction());
		// }
		// logger.debug("total number of lsTranasactionIds: " +
		// lsTranasactionIds.size());

		//
		// Collection<TreatmentGroup> treamentGroupSet = new
		// HashSet<TreatmentGroup>();
		// for (AnalysisGroup analysisGroup : analysisGroups){
		// List<TreatmentGroup> treatmentGroups =
		// TreatmentGroup.findTreatmentGroupsByAnalysisGroup(analysisGroup).getResultList();
		// logger.debug("found number of treatment group per analyisGroup: " +
		// analysisGroup.getId() + " " + treatmentGroups.size());
		// treamentGroupSet.addAll(treatmentGroups);
		// }
		// logger.debug("total number of treamentGroups: " +
		// treamentGroupSet.size());
		//
		// Collection<Subject> subjectSet = new HashSet<Subject>();
		// for (TreatmentGroup treamentGroup : treamentGroupSet){
		// List<Subject> subjectGroups =
		// Subject.findSubjectsByTreatmentGroup(treamentGroup).getResultList();
		// logger.debug("found number of subject group per treamentGroup: " +
		// treamentGroup.getId() + " " + subjectGroups.size());
		// subjectSet.addAll(subjectGroups);
		// }
		// logger.debug("total number of subjectSet: " + subjectSet.size());
		//
		// // now delete everything
		//
		// for (Subject subject : subjectSet){
		// subject.remove();
		// }
		//
		// for (TreatmentGroup subject : treamentGroupSet){
		// subject.remove();
		// }
		//
		// for (AnalysisGroup subject : analysisGroups){
		// subject.remove();
		// }
		//
		// experiment.remove();

		ItxSubjectContainerValue.deleteByExperimentID(id);
		ItxSubjectContainerState.deleteByExperimentID(id);
		ItxSubjectContainer.deleteByExperimentID(id);

		int deletedValues = SubjectValue.deleteByExperimentID(id);
		logger.debug("deleted number of subject values: " + deletedValues);

		int deletedLabels = SubjectLabel.deleteByExperimentID(id);
		logger.debug("deleted number of labels: " + deletedLabels);

		int numberOfStates = SubjectState.deleteByExperimentID(id);
		logger.debug("deleted number of numberOfStates: " + numberOfStates);

		// for (Long transactionId : lsTranasactionIds) {
		// logger.debug("current transaction to delete: " + transactionId);
		// //int deletedStates =
		// SubjectState.deleteByTransactionID(transactionId);
		// //logger.debug("deleted number of states: " + deletedStates);
		// }

		int deletedSubjects = Subject.deleteByExperimentID(id);
		logger.debug("deleted number of subjects: " + deletedSubjects);

		int tt2 = TreatmentGroupValue.deleteByExperimentID(id);
		logger.debug("deleted number of TreatmentGroupValue: " + tt2);

		int tt1 = TreatmentGroupState.deleteByExperimentID(id);
		logger.debug("deleted number of TreatmentGroupState: " + tt1);

		int tt3 = TreatmentGroupLabel.deleteByExperimentID(id);
		logger.debug("deleted number of TreatmentGroupLabel: " + tt3);

		int tt = TreatmentGroup.deleteByExperimentID(id);
		logger.debug("deleted number of TreatmentGroups: " + tt);

		int ag1 = AnalysisGroupValue.deleteByExperimentID(id);
		int ag2 = AnalysisGroupState.deleteByExperimentID(id);
		int ag3 = AnalysisGroupLabel.deleteByExperimentID(id);
		int ag4 = AnalysisGroup.deleteByExperimentID(id);
		logger.debug("deleted number of AnalysisGroupValue: " + ag1);
		logger.debug("deleted number of AnalysisGroupState: " + ag2);
		logger.debug("deleted number of AnalysisGroupLabel: " + ag3);
		logger.debug("deleted number of AnalysisGroup: " + ag4);

		Experiment.findExperiment(id).remove();
		logger.debug("deleted the experiment by cascade!"); // takes about a
															// minute

		//
		// int deletedAnalysisGroups = AnalysisGroup.deleteByExperimentID(id);
		// logger.debug("number of deletedAnalysisGroups: " +
		// deletedAnalysisGroups);
	}

	@Test
	@Transactional
	public void findExperiementByNameAndProtocol() {

		String labelText = "john test 2 9-2";
		String labelType = "name";
		String labelKind = "experiment name";
		boolean preferred = true;
		boolean ignored = true;
		long protocolId = 658L;
		List<ExperimentLabel> labels = ExperimentLabel
				.findExperimentLabelsByNameAndProtocol(labelText, labelType,
						labelKind, preferred, ignored, protocolId)
				.getResultList();

		logger.debug(ExperimentLabel.toJsonArray(labels));

	}

	@Test
	public void hydrateJson_test() {
		String josn = "{\"protocol\":{\"codeName\":\"PROT-00000026\",\"id\":484909,\"ignored\":false,\"lsKind\":\"default\",\"lsLabels\":[{\"id\":11714,\"ignored\":false,\"labelText\":\"APMS\",\"lsKind\":\"protocol name\",\"lsTransaction\":302,\"lsType\":\"name\",\"lsTypeAndKind\":\"name_protocol name\",\"physicallyLabled\":false,\"preferred\":true,\"recordedBy\":\"nouser\",\"recordedDate\":1393216025000,\"version\":0}],\"lsStates\":[],\"lsTags\":[],\"lsTransaction\":302,\"lsType\":\"default\",\"lsTypeAndKind\":\"default_default\",\"recordedBy\":\"nouser\",\"recordedDate\":1393216025000,\"shortDescription\":\"protocol created by generic data parser\",\"version\":1},\"codeName\":\"EXPT-00000389\",\"lsType\":\"default\",\"lsKind\":\"default\",\"shortDescription\":\"NA\",\"recordedBy\":\"nouser\",\"lsTransaction\":306,\"lsLabels\":[{\"experiment\":null,\"labelText\":\"Sample AMPS Expt 1001-V2\",\"recordedBy\":\"nouser\",\"lsType\":\"name\",\"lsKind\":\"experiment name\",\"preferred\":true,\"ignored\":false,\"lsTransaction\":306,\"recordedDate\":1393218563000}],\"lsStates\":[{\"experiment\":null,\"lsValues\":[{\"lsState\":null,\"lsType\":\"stringValue\",\"lsKind\":\"notebook\",\"stringValue\":\"JAM-000033\",\"fileValue\":null,\"urlValue\":null,\"dateValue\":null,\"clobValue\":null,\"blobValue\":null,\"operatorKind\":null,\"operatorType\":null,\"numericValue\":null,\"sigFigs\":null,\"uncertainty\":null,\"uncertaintyType\":null,\"numberOfReplicates\":null,\"unitKind\":null,\"comments\":null,\"ignored\":false,\"publicData\":true,\"codeValue\":null,\"recordedBy\":\"nouser\",\"recordedDate\":1393218563000,\"lsTransaction\":306},{\"lsState\":null,\"lsType\":\"stringValue\",\"lsKind\":\"notebook page\",\"stringValue\":\"6\",\"fileValue\":null,\"urlValue\":null,\"dateValue\":null,\"clobValue\":null,\"blobValue\":null,\"operatorKind\":null,\"operatorType\":null,\"numericValue\":null,\"sigFigs\":null,\"uncertainty\":null,\"uncertaintyType\":null,\"numberOfReplicates\":null,\"unitKind\":null,\"comments\":null,\"ignored\":false,\"publicData\":true,\"codeValue\":null,\"recordedBy\":\"nouser\",\"recordedDate\":1393218563000,\"lsTransaction\":306},{\"lsState\":null,\"lsType\":\"dateValue\",\"lsKind\":\"completion date\",\"stringValue\":null,\"fileValue\":null,\"urlValue\":null,\"dateValue\":1373270400000,\"clobValue\":null,\"blobValue\":null,\"operatorKind\":null,\"operatorType\":null,\"numericValue\":null,\"sigFigs\":null,\"uncertainty\":null,\"uncertaintyType\":null,\"numberOfReplicates\":null,\"unitKind\":null,\"comments\":null,\"ignored\":false,\"publicData\":true,\"codeValue\":null,\"recordedBy\":\"nouser\",\"recordedDate\":1393218563000,\"lsTransaction\":306},{\"lsState\":null,\"lsType\":\"codeValue\",\"lsKind\":\"scientist\",\"codeValue\":\"jmcneil\",\"fileValue\":null,\"urlValue\":null,\"dateValue\":null,\"clobValue\":null,\"blobValue\":null,\"operatorKind\":null,\"operatorType\":null,\"numericValue\":null,\"sigFigs\":null,\"uncertainty\":null,\"uncertaintyType\":null,\"numberOfReplicates\":null,\"unitKind\":null,\"comments\":null,\"ignored\":false,\"publicData\":true,\"recordedBy\":\"nouser\",\"recordedDate\":1393218563000,\"lsTransaction\":306},{\"lsState\":null,\"lsType\":\"stringValue\",\"lsKind\":\"status\",\"stringValue\":\"Approved\",\"fileValue\":null,\"urlValue\":null,\"dateValue\":null,\"clobValue\":null,\"blobValue\":null,\"operatorKind\":null,\"operatorType\":null,\"numericValue\":null,\"sigFigs\":null,\"uncertainty\":null,\"uncertaintyType\":null,\"numberOfReplicates\":null,\"unitKind\":null,\"comments\":null,\"ignored\":false,\"publicData\":true,\"codeValue\":null,\"recordedBy\":\"nouser\",\"recordedDate\":1393218563000,\"lsTransaction\":306},{\"lsState\":null,\"lsType\":\"stringValue\",\"lsKind\":\"analysis status\",\"stringValue\":\"running\",\"fileValue\":null,\"urlValue\":null,\"dateValue\":null,\"clobValue\":null,\"blobValue\":null,\"operatorKind\":null,\"operatorType\":null,\"numericValue\":null,\"sigFigs\":null,\"uncertainty\":null,\"uncertaintyType\":null,\"numberOfReplicates\":null,\"unitKind\":null,\"comments\":null,\"ignored\":false,\"publicData\":true,\"codeValue\":null,\"recordedBy\":\"nouser\",\"recordedDate\":1393218563000,\"lsTransaction\":306},{\"lsState\":null,\"lsType\":\"clobValue\",\"lsKind\":\"analysis result html\",\"stringValue\":null,\"fileValue\":null,\"urlValue\":null,\"dateValue\":null,\"clobValue\":\"<p>Analysis not yet completed</p>\",\"blobValue\":null,\"operatorKind\":null,\"operatorType\":null,\"numericValue\":null,\"sigFigs\":null,\"uncertainty\":null,\"uncertaintyType\":null,\"numberOfReplicates\":null,\"unitKind\":null,\"comments\":null,\"ignored\":false,\"publicData\":true,\"codeValue\":null,\"recordedBy\":\"nouser\",\"recordedDate\":1393218563000,\"lsTransaction\":306},{\"lsState\":null,\"lsType\":\"codeValue\",\"lsKind\":\"project\",\"stringValue\":null,\"fileValue\":null,\"urlValue\":null,\"dateValue\":null,\"clobValue\":null,\"blobValue\":null,\"operatorKind\":null,\"operatorType\":null,\"numericValue\":null,\"sigFigs\":null,\"uncertainty\":null,\"uncertaintyType\":null,\"numberOfReplicates\":null,\"unitKind\":null,\"comments\":null,\"ignored\":false,\"publicData\":true,\"codeValue\":\"Fluomics Project 3\",\"recordedBy\":\"nouser\",\"recordedDate\":1393218563000,\"lsTransaction\":306}],\"recordedBy\":\"nouser\",\"lsType\":\"metadata\",\"lsKind\":\"experiment metadata\",\"comments\":\"\",\"lsTransaction\":306,\"ignored\":false,\"recordedDate\":1393218563000}],\"lsTags\":[{\"tagText\":[\"apple\",\"banana\"],\"id\":null,\"version\":null,\"recordedDate\":1393218563000}],\"recordedDate\":1393218563000}";
	}

	@Test
	public void findAndSaveExperimentFromJson1() throws NotFoundException {
		String experimentName = "Test Experiment Brian";
		String json = "{\"codeName\":null,\"id\":null,\"ignored\":false,\"lsKind\":\"default\",\"lsLabels\":[{\"id\":null,\"ignored\":false,\"labelText\":\"Test Experiment Brian\",\"lsKind\":\"experiment name\",\"lsTransaction\":22,\"lsType\":\"name\",\"lsTypeAndKind\":\"name_experiment name\",\"physicallyLabled\":false,\"preferred\":true,\"recordedBy\":\"nouser\",\"recordedDate\":1396912531000,\"version\":null}],\"lsStates\":[{\"comments\":\"\",\"id\":null,\"ignored\":false,\"lsKind\":\"raw results locations\",\"lsTransaction\":22,\"lsType\":\"metadata\",\"lsTypeAndKind\":\"metadata_raw results locations\",\"lsValues\":[{\"codeTypeAndKind\":\"null_null\",\"fileValue\":\"experiments/EXPT-00000017/2_Concentration2.xls\",\"id\":null,\"ignored\":false,\"lsKind\":\"source file\",\"lsTransaction\":22,\"lsType\":\"fileValue\",\"lsTypeAndKind\":\"fileValue_source file\",\"operatorTypeAndKind\":\"null_null\",\"publicData\":true,\"recordedBy\":\"nouser\",\"recordedDate\":1396912531000,\"unitTypeAndKind\":\"null_null\",\"version\":null}],\"recordedBy\":\"nouser\",\"recordedDate\":1396912531000,\"version\":null},{\"id\":null,\"ignored\":false,\"lsKind\":\"experiment metadata\",\"lsTransaction\":22,\"lsType\":\"metadata\",\"lsTypeAndKind\":\"metadata_experiment metadata\",\"lsValues\":[{\"codeTypeAndKind\":\"null_null\",\"id\":null,\"ignored\":false,\"lsKind\":\"scientist\",\"lsTransaction\":22,\"lsType\":\"codeValue\",\"lsTypeAndKind\":\"codeValue_scientist\",\"operatorTypeAndKind\":\"null_null\",\"publicData\":true,\"recordedBy\":\"nouser\",\"recordedDate\":1396912531000,\"codeValue\":\"jmcneil\",\"unitTypeAndKind\":\"null_null\",\"version\":null},{\"codeTypeAndKind\":\"null_null\",\"id\":null,\"ignored\":false,\"lsKind\":\"notebook\",\"lsTransaction\":22,\"lsType\":\"stringValue\",\"lsTypeAndKind\":\"stringValue_notebook\",\"operatorTypeAndKind\":\"null_null\",\"publicData\":true,\"recordedBy\":\"nouser\",\"recordedDate\":1396912531000,\"stringValue\":\"JM-576\",\"unitTypeAndKind\":\"null_null\",\"version\":null},{\"codeTypeAndKind\":\"null_null\",\"id\":null,\"ignored\":false,\"lsKind\":\"analysis status\",\"lsTransaction\":22,\"lsType\":\"stringValue\",\"lsTypeAndKind\":\"stringValue_analysis status\",\"operatorTypeAndKind\":\"null_null\",\"publicData\":true,\"recordedBy\":\"username\",\"recordedDate\":1396912532000,\"stringValue\":\"complete\",\"unitTypeAndKind\":\"null_null\",\"version\":null},{\"codeTypeAndKind\":\"null_null\",\"id\":null,\"ignored\":false,\"lsKind\":\"status\",\"lsTransaction\":22,\"lsType\":\"stringValue\",\"lsTypeAndKind\":\"stringValue_status\",\"operatorTypeAndKind\":\"null_null\",\"publicData\":true,\"recordedBy\":\"nouser\",\"recordedDate\":1396912531000,\"stringValue\":\"Approved\",\"unitTypeAndKind\":\"null_null\",\"version\":null},{\"codeTypeAndKind\":\"null_null\",\"dateValue\":1342076400000,\"id\":null,\"ignored\":false,\"lsKind\":\"completion date\",\"lsTransaction\":22,\"lsType\":\"dateValue\",\"lsTypeAndKind\":\"dateValue_completion date\",\"operatorTypeAndKind\":\"null_null\",\"publicData\":true,\"recordedBy\":\"nouser\",\"recordedDate\":1396912531000,\"unitTypeAndKind\":\"null_null\",\"version\":null},{\"codeTypeAndKind\":\"null_null\",\"id\":null,\"ignored\":false,\"lsKind\":\"notebook page\",\"lsTransaction\":22,\"lsType\":\"stringValue\",\"lsTypeAndKind\":\"stringValue_notebook page\",\"operatorTypeAndKind\":\"null_null\",\"publicData\":true,\"recordedBy\":\"nouser\",\"recordedDate\":1396912531000,\"stringValue\":\"12\",\"unitTypeAndKind\":\"null_null\",\"version\":null}],\"recordedBy\":\"nouser\",\"recordedDate\":1396912531000,\"version\": null}],\"lsTags\":[],\"lsTransaction\":22,\"lsType\":\"default\",\"lsTypeAndKind\":\"default_default\",\"protocol\":{\"codeName\":\"PROT-00000009\",\"id\":1584,\"ignored\":false,\"lsKind\":\"default\",\"lsTransaction\":12,\"lsType\":\"default\",\"lsTypeAndKind\":\"default_default\",\"recordedBy\":\"nouser\",\"recordedDate\":1396403869000,\"shortDescription\":\"protocol created by generic data parser\",\"version\": null},\"recordedBy\":\"nouser\",\"recordedDate\":1396912531000,\"shortDescription\":\"experiment created by generic data parser\",\"version\": null}";
		List<Experiment> check1 = Experiment.findExperimentListByExperimentNameAndIgnoredNot(experimentName);
		Assert.assertTrue(check1.isEmpty());
		Experiment experiment = null;
		try {
			experiment = experimentService.saveLsExperiment(Experiment.fromJsonToExperiment(json));
		} catch (UniqueNameException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		logger.info("Saved experiment with id:" + experiment.getId());
		List<Experiment> check2 = Experiment.findExperimentListByExperimentNameAndIgnoredNot(experimentName);
		Assert.assertFalse(check2.isEmpty());
	}

	@Test
	public void findAndSaveExperimentFromJson2() throws NotFoundException {
		String experimentName = "Test Experiment Brian";
		String json = "{\"codeName\":null,\"id\":null,\"ignored\":false,\"lsKind\":\"default\",\"lsLabels\":[{\"id\":null,\"ignored\":false,\"labelText\":\"Test Experiment Brian\",\"lsKind\":\"experiment name\",\"lsTransaction\":22,\"lsType\":\"name\",\"lsTypeAndKind\":\"name_experiment name\",\"physicallyLabled\":false,\"preferred\":true,\"recordedBy\":\"nouser\",\"recordedDate\":null,\"version\":null}],\"lsStates\":[{\"comments\":\"\",\"id\":null,\"ignored\":false,\"lsKind\":\"raw results locations\",\"lsTransaction\":22,\"lsType\":\"metadata\",\"lsTypeAndKind\":\"metadata_raw results locations\",\"lsValues\":[{\"codeTypeAndKind\":\"null_null\",\"fileValue\":\"experiments/EXPT-00000017/2_Concentration2.xls\",\"id\":null,\"ignored\":false,\"lsKind\":\"source file\",\"lsTransaction\":22,\"lsType\":\"fileValue\",\"lsTypeAndKind\":\"fileValue_source file\",\"operatorTypeAndKind\":\"null_null\",\"publicData\":true,\"recordedBy\":\"nouser\",\"recordedDate\":null,\"unitTypeAndKind\":\"null_null\",\"version\":null}],\"recordedBy\":\"nouser\",\"recordedDate\":null,\"version\":null},{\"id\":null,\"ignored\":false,\"lsKind\":\"experiment metadata\",\"lsTransaction\":22,\"lsType\":\"metadata\",\"lsTypeAndKind\":\"metadata_experiment metadata\",\"lsValues\":[{\"codeTypeAndKind\":\"null_null\",\"id\":null,\"ignored\":false,\"lsKind\":\"scientist\",\"lsTransaction\":22,\"lsType\":\"codeValue\",\"lsTypeAndKind\":\"codeValue_scientist\",\"operatorTypeAndKind\":\"null_null\",\"publicData\":true,\"recordedBy\":\"nouser\",\"recordedDate\":null,\"codeValue\":\"jmcneil\",\"unitTypeAndKind\":\"null_null\",\"version\":null},{\"codeTypeAndKind\":\"null_null\",\"id\":null,\"ignored\":false,\"lsKind\":\"notebook\",\"lsTransaction\":22,\"lsType\":\"stringValue\",\"lsTypeAndKind\":\"stringValue_notebook\",\"operatorTypeAndKind\":\"null_null\",\"publicData\":true,\"recordedBy\":\"nouser\",\"recordedDate\":null,\"stringValue\":\"JM-576\",\"unitTypeAndKind\":\"null_null\",\"version\":null},{\"codeTypeAndKind\":\"null_null\",\"id\":null,\"ignored\":false,\"lsKind\":\"analysis status\",\"lsTransaction\":22,\"lsType\":\"stringValue\",\"lsTypeAndKind\":\"stringValue_analysis status\",\"operatorTypeAndKind\":\"null_null\",\"publicData\":true,\"recordedBy\":\"username\",\"recordedDate\":null,\"stringValue\":\"complete\",\"unitTypeAndKind\":\"null_null\",\"version\":null},{\"codeTypeAndKind\":\"null_null\",\"id\":null,\"ignored\":false,\"lsKind\":\"status\",\"lsTransaction\":22,\"lsType\":\"stringValue\",\"lsTypeAndKind\":\"stringValue_status\",\"operatorTypeAndKind\":\"null_null\",\"publicData\":true,\"recordedBy\":\"nouser\",\"recordedDate\":null,\"stringValue\":\"Approved\",\"unitTypeAndKind\":\"null_null\",\"version\":null},{\"codeTypeAndKind\":\"null_null\",\"dateValue\":1342076400000,\"id\":null,\"ignored\":false,\"lsKind\":\"completion date\",\"lsTransaction\":22,\"lsType\":\"dateValue\",\"lsTypeAndKind\":\"dateValue_completion date\",\"operatorTypeAndKind\":\"null_null\",\"publicData\":true,\"recordedBy\":\"nouser\",\"recordedDate\":null,\"unitTypeAndKind\":\"null_null\",\"version\":null},{\"codeTypeAndKind\":\"null_null\",\"id\":null,\"ignored\":false,\"lsKind\":\"notebook page\",\"lsTransaction\":22,\"lsType\":\"stringValue\",\"lsTypeAndKind\":\"stringValue_notebook page\",\"operatorTypeAndKind\":\"null_null\",\"publicData\":true,\"recordedBy\":\"nouser\",\"recordedDate\":null,\"stringValue\":\"12\",\"unitTypeAndKind\":\"null_null\",\"version\":null}],\"recordedBy\":\"nouser\",\"recordedDate\":null,\"version\": null}],\"lsTags\":[],\"lsTransaction\":22,\"lsType\":\"default\",\"lsTypeAndKind\":\"default_default\",\"protocol\":{\"codeName\":\"PROT-00000009\",\"id\":1584,\"ignored\":false,\"lsKind\":\"default\",\"lsTransaction\":12,\"lsType\":\"default\",\"lsTypeAndKind\":\"default_default\",\"recordedBy\":\"nouser\",\"recordedDate\":null,\"shortDescription\":\"protocol created by generic data parser\",\"version\": null},\"recordedBy\":\"nouser\",\"recordedDate\":null,\"shortDescription\":\"experiment created by generic data parser\",\"version\": null}";
		List<Experiment> check1 = Experiment.findExperimentListByExperimentNameAndIgnoredNot(experimentName);
		Assert.assertEquals(1, check1.size());
		Experiment experiment = new Experiment();
		Boolean caughtException = false;
		try {
			experiment = experimentService.saveLsExperiment(Experiment.fromJsonToExperiment(json));
			experiment.persist();
		} catch (UniqueNameException e) {
			caughtException = true;
		}
		Assert.assertTrue(caughtException);
		logger.info("Saved experiment with id:" + experiment.getId());
		List<Experiment> check2 = Experiment.findExperimentListByExperimentNameAndIgnoredNot(experimentName);
		Assert.assertEquals(1, check2.size());
	}

	@Test
	// @Transactional
	public void deleteExperimentByName() {
		String experimentName = "Test Experiment Brian";
		List<Experiment> check1 = Experiment.findExperimentListByExperimentNameAndIgnoredNot(experimentName);
		Assert.assertEquals(1, check1.size());
		for (Experiment experiment : check1) {
			experiment.logicalDelete();
		}
		List<Experiment> check2 = Experiment.findExperimentListByExperimentNameAndIgnoredNot(experimentName);
		Assert.assertTrue(check2.isEmpty());
	}

	@Test
	public void verifyDeleted() {
		String experimentName = "Test Experiment Brian";
		List<Experiment> check1 = Experiment.findExperimentListByExperimentNameAndIgnoredNot(experimentName);
		Assert.assertEquals(0, check1.size());
	}

	@Transactional
	@Test
	public void experimentBrowserFilterTest() {
		String protocolName = "PAMPA Buffer A";
		String protocolCodeName = "PROT-00000001";
		String protocolType = "default";
		String protocolKind = "default";
		String name = "Buffer A Test01";
		String codeName = "EXPT-00000001";
		String type = "default";
		String kind = "default";

		Map<String, String> requestParams = new HashMap<String, String>();
		requestParams.put("protocolName", protocolName);

		Set<Experiment> experiments = experimentService.findExperimentsByRequestMetadata(requestParams);
		Assert.assertEquals(1, experiments.size());
		experiments.clear();

		requestParams.put("protocolCodeName", protocolCodeName);
		experiments = experimentService.findExperimentsByRequestMetadata(requestParams);
		Assert.assertEquals(1, experiments.size());
		experiments.clear();

		requestParams.put("protocolType", protocolType);
		requestParams.put("protocolKind", protocolKind);

		experiments = experimentService.findExperimentsByRequestMetadata(requestParams);
		Assert.assertEquals(1, experiments.size());
		experiments.clear();

		requestParams.remove("protocolName");
		experiments = experimentService.findExperimentsByRequestMetadata(requestParams);
		Assert.assertEquals(1, experiments.size());

		requestParams.clear();

		requestParams.put("name", name);

		experiments = experimentService.findExperimentsByRequestMetadata(requestParams);
		Assert.assertEquals(1, experiments.size());
		experiments.clear();

		requestParams.put("codeName", codeName);
		experiments = experimentService.findExperimentsByRequestMetadata(requestParams);
		Assert.assertEquals(1, experiments.size());
		experiments.clear();

		requestParams.put("type", type);
		requestParams.put("kind", kind);

		experiments = experimentService.findExperimentsByRequestMetadata(requestParams);
		Assert.assertEquals(1, experiments.size());
		experiments.clear();

		requestParams.remove("name");
		experiments = experimentService.findExperimentsByRequestMetadata(requestParams);
		Assert.assertEquals(1, experiments.size());
	}

	@Test
	public void softDeletedTest() {
		Long id = 14L;
		Experiment experiment = Experiment.findExperiment(id);
		Assert.assertFalse(experimentService.isSoftDeleted(experiment));
		experimentValueService.updateExperimentValue(experiment.getCodeName(), "metadata", "experiment metadata",
				"stringValue", "status", "Deleted");
		experiment.setIgnored(true);
		Assert.assertTrue(experimentService.isSoftDeleted(experiment));
		experimentValueService.updateExperimentValue(experiment.getCodeName(), "metadata", "experiment metadata",
				"stringValue", "status", "Approved");
		experiment.setIgnored(false);
		Assert.assertFalse(experimentService.isSoftDeleted(experiment));
		experimentValueService.updateExperimentValue(experiment.getCodeName(), "metadata", "experiment metadata",
				"stringValue", "status", "Deleted");
		experiment.setIgnored(true);
		experiment.setDeleted(true);
		Assert.assertFalse(experimentService.isSoftDeleted(experiment));

	}

	@Test
	// @Transactional
	public void browserFinderDeleteTest() throws TooManyResultsException {
		Long id = 2123L;
		String query = "EXPERIMENT 4 EXPT-00000006";
		Experiment experiment = Experiment.findExperiment(id);
		Collection<Experiment> experiments = experimentService.findExperimentsByGenericMetaDataSearch(query, false);
		Assert.assertEquals(1, experiments.size());
		Assert.assertEquals(experiment.getId(), experiments.iterator().next().getId());
		experiments.clear();

		experimentValueService.updateExperimentValue(experiment.getCodeName(), "metadata", "experiment metadata",
				"stringValue", "status", "Deleted");
		experiment.setIgnored(true);
		experiment.merge();
		experiment.flush();
		experiments = experimentService.findExperimentsByGenericMetaDataSearch(query, false);
		Assert.assertEquals(1, experiments.size());
		Assert.assertEquals(experiment.getId(), experiments.iterator().next().getId());
		experiments.clear();
	}

	@Test
	public void browserFinderDeleteTest2() throws TooManyResultsException {
		Long id = 2123L;
		String query = "EXPERIMENT 4 EXPT-00000006";
		Experiment experiment = Experiment.findExperiment(id);
		experiment.setDeleted(true);
		experimentValueService.updateExperimentValue(experiment.getCodeName(), "metadata", "experiment metadata",
				"stringValue", "status", "Deleted");
		experiment.setIgnored(true);
		experiment.merge();
		experiment.flush();
		Collection<Experiment> experiments = experimentService.findExperimentsByGenericMetaDataSearch(query, false);
		Assert.assertEquals(0, experiments.size());

	}

	@Test
	public void browserFinderDeleteTest3() {
		Long id = 2123L;
		Experiment experiment = Experiment.findExperiment(id);
		experiment.setIgnored(false);
		experiment.setDeleted(false);
		experiment.merge();
		experiment.flush();
	}

	@Test
	@Transactional
	public void uniqueNameExceptionTest() throws UniqueNameException, NotFoundException {
		String experimentName = "Test Load 102";
		String json = "{\"codeName\":null,\"deleted\":false,\"id\":null,\"ignored\":false,\"lsKind\":\"default\",\"lsLabels\":[{\"deleted\":false,\"id\":null,\"ignored\":false,\"labelText\":\"Test Load 102\",\"lsKind\":\"experiment name\",\"lsTransaction\":5,\"lsType\":\"name\",\"lsTypeAndKind\":\"name_experiment name\",\"physicallyLabled\":false,\"preferred\":true,\"recordedBy\":\"nouser\",\"recordedDate\":1395708973000,\"version\":null}],\"lsStates\":[],\"lsTransaction\":5,\"lsType\":\"default\",\"lsTypeAndKind\":\"default_default\",\"protocol\":{\"codeName\":\"PROT-00000002\",\"deleted\":false,\"id\":1006,\"ignored\":false,\"lsKind\":\"default\",\"lsTransaction\":5,\"lsType\":\"default\",\"lsTypeAndKind\":\"default_default\",\"recordedBy\":\"nouser\",\"recordedDate\":1395708972000,\"shortDescription\":\"protocol created by generic data parser\",\"version\":null},\"recordedBy\":\"nouser\",\"recordedDate\":1395708973000,\"shortDescription\":\"NA\",\"version\":null}";
		Experiment experiment = Experiment.fromJsonToExperiment(json);
		try {
			experimentService.saveLsExperiment(experiment);
		} catch (UniqueNameException e) {
			Assert.assertNotNull(e);
		}
	}

	@Transactional
	@Test
	public void searchTest2() throws TooManyResultsException {
		String query = "EXPT-00000012";
		Collection<Experiment> experiments = experimentService.findExperimentsByGenericMetaDataSearch(query, false);
		logger.debug("RESULTS: " + "NUMBER OF EXPERIMENTS: " + experiments.size() + experiments.toString());
	}

	@Test
	// @Transactional
	public void createExperimentStatusTest() {
		Experiment experiment = Experiment.findExperiment(7585L);
		ExperimentValue experimentValue = experimentValueService.updateExperimentValue(experiment.getCodeName(),
				"metadata", "experiment metadata", "codeValue", "experiment status", "created");
		String createdExperimentStatus = experimentValue.getCodeValue();
		Assert.assertEquals("created", createdExperimentStatus);
	}

	@Test
	@Transactional
	public void updateExperimentStatusTest() {
		Experiment experiment = Experiment.findExperiment(7585L);
		ExperimentValue experimentValue = ExperimentValue
				.findExperimentValuesByExptIDAndStateTypeKindAndValueTypeKind(experiment.getId(), "metadata",
						"experiment metadata", "codeValue", "experiment status")
				.getSingleResult();
		String originalExperimentStatus = experimentValue.getCodeValue();
		Assert.assertTrue(!originalExperimentStatus.equals("deleted"));
		ExperimentValue experimentValue2 = experimentValueService.updateExperimentValue(experiment.getCodeName(),
				"metadata", "experiment metadata", "codeValue", "experiment status", "deleted");
		experiment.setIgnored(true);
		String deletedExperimentStatus = experimentValue2.getCodeValue();
		ExperimentValue experimentValue3 = ExperimentValue
				.findExperimentValuesByExptIDAndStateTypeKindAndValueTypeKind(experiment.getId(), "metadata",
						"experiment metadata", "codeValue", "experiment status")
				.getSingleResult();
		String checkDeletedExperimentStatus = experimentValue3.getCodeValue();
		Assert.assertEquals("deleted", deletedExperimentStatus);
		Assert.assertEquals("deleted", checkDeletedExperimentStatus);

	}

	@Test
	@Transactional
	@Rollback(value = false)
	public void deleteChildren() {
		Experiment experiment = Experiment.findExperiment(203528L);
		long startTime = new Date().getTime();
		experimentService.deleteAnalysisGroupsByExperiment(experiment);
		long endTime = new Date().getTime();
		long totalTime = endTime - startTime;
		logger.info("Time to delete " + totalTime + " ms");

	}

	@Test
	@Transactional
	@Rollback(value = false)
	public void changeProtocol() throws Exception {
		Experiment experiment = Experiment.findExperiment(1007L);
		Protocol newProtocol = Protocol.findProtocol(708326L);
		Assert.assertFalse(experiment.getProtocol().getId() == newProtocol.getId());
		Assert.assertFalse(experiment.getProtocol().getCodeName().equals(newProtocol.getCodeName()));
		// logger.info(newProtocol.toJson());
		// logger.info(experiment.toJson());
		experiment.setProtocol(newProtocol);
		Experiment updatedExperiment = experimentService.updateExperiment(experiment);
		// logger.info(updatedExperiment.toJson());
		Assert.assertTrue(updatedExperiment.getProtocol().getId() == newProtocol.getId());
		Assert.assertTrue(updatedExperiment.getProtocol().getCodeName().equals(newProtocol.getCodeName()));
	}

	@Transactional
	@Test
	public void experimentBrowserSearchTest2() throws Exception {
		String query = "EXPERIMENT 5";
		logger.info("Searching with the query: " + query);
		Collection<Experiment> resultExperiments = experimentService.findExperimentsByGenericMetaDataSearch(query, false);
		logger.info("Found: " + resultExperiments.toString());
		Assert.assertTrue(resultExperiments.size() > 0);
		query = "\"EXPERIMENT 5\"";
		logger.info("Searching with the query: " + query);
		Collection<Experiment> resultExperiments2 = experimentService.findExperimentsByGenericMetaDataSearch(query, false);
		logger.info("Found: " + resultExperiments2.toString());
		Assert.assertTrue(resultExperiments2.size() > 0);
		Assert.assertTrue(resultExperiments.size() != resultExperiments2.size());

		query = "EXPERIMENT 50";
		logger.info("Searching with the query: " + query);
		resultExperiments = experimentService.findExperimentsByGenericMetaDataSearch(query, false);
		logger.info("Found: " + resultExperiments.toString());
		Assert.assertTrue(resultExperiments.size() > 0);
		query = "\"EXPERIMENT 50\"";
		logger.info("Searching with the query: " + query);
		resultExperiments2 = experimentService.findExperimentsByGenericMetaDataSearch(query, false);
		logger.info("Found: " + resultExperiments2.toString());
		Assert.assertTrue(resultExperiments2.size() > 0);
		Assert.assertEquals(resultExperiments.iterator().next().getCodeName(),
				resultExperiments2.iterator().next().getCodeName());
	}

	@Transactional
	@Test
	public void experimentBrowser_dateSearch() throws Exception {
		String query = "2015-05-08";
		logger.info("Searching with the query: " + query);
		Collection<Experiment> resultExperiments = experimentService.findExperimentsByGenericMetaDataSearch(query, false);
		logger.info("Found: " + resultExperiments.toString());
		Assert.assertTrue(resultExperiments.size() > 0);

	}

	@Transactional
	@Rollback(value = false)
	@Test
	public void updateExperiment() throws UniqueNameException {
		String json = "{\"id\":1035,\"codeName\":\"EXPT-00000061\",\"lsType\":\"default\",\"lsKind\":\"study\",\"protocol\":{\"codeName\":\"PROT-00000020\",\"deleted\":false,\"id\":1034,\"ignored\":false,\"lsKind\":\"study\",\"lsTransaction\":306,\"lsType\":\"default\",\"lsTypeAndKind\":\"default_study\",\"modifiedDate\":1471906899841,\"recordedBy\":\"bob\",\"recordedDate\":1471906899636,\"shortDescription\":\" \",\"version\":1},\"recordedDate\":1471909718042,\"recordedBy\":\"bob\",\"lsStates\":[{\"ignored\":false,\"lsKind\":\"study steps\",\"lsType\":\"study tracking\",\"lsValues\":[{\"ignored\":false,\"lsKind\":\"step order\",\"lsType\":\"numericValue\",\"numericValue\":0,\"recordedBy\":\"bob\",\"recordedDate\":1471911582836,\"lsTransaction\":323},{\"ignored\":false,\"lsKind\":\"step category order\",\"lsType\":\"numericValue\",\"numericValue\":2,\"recordedBy\":\"bob\",\"recordedDate\":1471911582836,\"lsTransaction\":323},{\"ignored\":false,\"lsKind\":\"step category\",\"lsType\":\"stringValue\",\"recordedBy\":\"bob\",\"recordedDate\":1471911582836,\"stringValue\":\"Uncategorized\",\"lsTransaction\":323},{\"ignored\":false,\"lsKind\":\"step name\",\"lsType\":\"stringValue\",\"stringValue\":\"EXPT-00000068\",\"recordedBy\":\"bob\",\"recordedDate\":1471911582836,\"lsTransaction\":323}],\"recordedBy\":\"bob\",\"recordedDate\":1471911582836,\"lsTransaction\":323}],\"lsTransaction\":323}";
		Experiment exptToUpdate = Experiment.fromJsonToExperiment(json);
		Experiment updatedExperiment = experimentService.updateExperiment(exptToUpdate);
		logger.info(updatedExperiment.toJson());
	}

	@Transactional
	@Test
	public void getExperimentsAsCodeTables() {
		List<CodeTableDTO> codeTables = experimentService.getExperimentsAsCodeTables(null, null);
		Assert.assertFalse(codeTables.isEmpty());
		logger.info(CodeTableDTO.toJsonArray(codeTables));
		codeTables = experimentService.getExperimentsAsCodeTables("default", null);
		Assert.assertFalse(codeTables.isEmpty());
		logger.info(CodeTableDTO.toJsonArray(codeTables));
		codeTables = experimentService.getExperimentsAsCodeTables("default", "default");
		Assert.assertFalse(codeTables.isEmpty());
		logger.info(CodeTableDTO.toJsonArray(codeTables));
	}

	@Test
	@Transactional
	public void getExperimentsByDateValueComparison() throws Exception {
		DateValueComparisonRequest request = new DateValueComparisonRequest();
		request.setStateType("metadata");
		request.setStateKind("experiment metadata");
		request.setValueKind("completion date");
		request.setSecondsDelta(60);

		Collection<String> results = experimentService.getExperimentCodesByDateValueComparison(request);
		logger.info(results.toString());
		Assert.assertTrue(results.size() > 0);

		request.setNewerThanModified(true);
		Collection<String> noResults = experimentService.getExperimentCodesByDateValueComparison(request);
		logger.info(noResults.toString());
		Assert.assertFalse(noResults.size() > 0);
	}

}
